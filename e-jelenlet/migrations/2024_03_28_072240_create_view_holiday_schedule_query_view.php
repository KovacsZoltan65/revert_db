<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Support\Facades\DB;

return new class extends Migration
{
    /**
     * Run the migrations.
     *
     * @return void
     */
    public function up()
    {
        DB::statement("CREATE VIEW `view_holiday_schedule_query` AS select `legal_entities_rel`.`core_legal_entities_id` AS `core_legal_entities_id`,`rules`.`id` AS `attendance_holiday_rule_id`,`rules`.`name` AS `holiday_rule_name`,`rules_schedules`.`id` AS `attendance_holiday_rules_schedule_id`,`permission_groups_rel`.`core_permission_group_id` AS `core_permission_group_id`,`rules`.`year` AS `planning_year`,`rules_schedules`.`planning_from_date` AS `planning_from_date`,`rules_schedules`.`planning_to_date` AS `planning_to_date`,`rules_schedules`.`planning_deadline` AS `planning_deadline`,`rules_schedules`.`percentage_of_holidays` AS `percentage_of_holidays`,`rules_schedules`.`minimum_number_of_required_days` AS `minimum_number_of_required_days`,`rules_schedules`.`worker_has` AS `worker_has`,`rules_schedules`.`required_at_once` AS `required_at_once`,`holiday_amounts`.`value` AS `total_holiday_amounts`,sum(`total`.`so_far_total`) AS `so_far_total`,(case when (`rules_schedules`.`planning_to_date` <> `max`.`last_max`) then round(((`holiday_amounts`.`value` / 100) * `rules_schedules`.`percentage_of_holidays`),0) else (round(((`holiday_amounts`.`value` / 100) * `rules_schedules`.`percentage_of_holidays`),0) - (sum(`total`.`so_far_total`) - `holiday_amounts`.`value`)) end) AS `percentage_proportionally_holiday_amounts`,`offdays`.`used` AS `used`,`offdays`.`used_dates` AS `used_dates`,`offdays`.`used_created_ats` AS `used_created_ats`,`offdays`.`used_abscences_ids` AS `used_abscences_ids`,`offdays`.`planned` AS `planned`,`offdays`.`planned_dates` AS `planned_dates`,`offdays`.`planned_created_ats` AS `planned_created_ats`,`offdays`.`planned_abscences_ids` AS `planned_abscences_ids` from (((((((`ej2_showtime_p`.`attendance_holiday_rules` `rules` join `ej2_showtime_p`.`attendance_holiday_rules_legal_entities_rel` `legal_entities_rel` on((`legal_entities_rel`.`attendance_holiday_rule_id` = `rules`.`id`))) left join `ej2_showtime_p`.`attendance_holiday_rule_schedules` `rules_schedules` on((`rules_schedules`.`attendance_holiday_rule_id` = `rules`.`id`))) left join (select `ej2_showtime_p`.`attendance_holiday_rule_schedules`.`attendance_holiday_rule_id` AS `max_rules_id`,max(`ej2_showtime_p`.`attendance_holiday_rule_schedules`.`planning_to_date`) AS `last_max` from `ej2_showtime_p`.`attendance_holiday_rule_schedules` where (`ej2_showtime_p`.`attendance_holiday_rule_schedules`.`percentage_of_holidays` > 0) group by `max_rules_id`) `max` on((`rules`.`id` = `max`.`max_rules_id`))) left join (select `ej2_showtime_p`.`attendance_holiday_rules_legal_entities_rel`.`core_legal_entities_id` AS `legal_entity`,`ej2_showtime_p`.`attendance_legal_entities_holiday_amounts`.`year` AS `total_year`,`ej2_showtime_p`.`attendance_holiday_rules`.`id` AS `rules_id`,`ej2_showtime_p`.`attendance_holiday_rule_schedules`.`id` AS `schedules_id`,round((sum(`ej2_showtime_p`.`attendance_legal_entities_holiday_amounts`.`value`) * (`ej2_showtime_p`.`attendance_holiday_rule_schedules`.`percentage_of_holidays` / 100)),0) AS `so_far_total` from (((`ej2_showtime_p`.`attendance_holiday_rules_legal_entities_rel` left join `ej2_showtime_p`.`attendance_holiday_rules` on((`ej2_showtime_p`.`attendance_holiday_rules`.`id` = `ej2_showtime_p`.`attendance_holiday_rules_legal_entities_rel`.`attendance_holiday_rule_id`))) left join `ej2_showtime_p`.`attendance_holiday_rule_schedules` on((`ej2_showtime_p`.`attendance_holiday_rule_schedules`.`attendance_holiday_rule_id` = `ej2_showtime_p`.`attendance_holiday_rules`.`id`))) left join `ej2_showtime_p`.`attendance_legal_entities_holiday_amounts` on(((`ej2_showtime_p`.`attendance_holiday_rules_legal_entities_rel`.`core_legal_entities_id` = `ej2_showtime_p`.`attendance_legal_entities_holiday_amounts`.`core_legal_entities_id`) and (0 <> find_in_set(`ej2_showtime_p`.`attendance_legal_entities_holiday_amounts`.`attendance_offday_types_id`,'1,2,3,4,5,6,7,99')) and (`ej2_showtime_p`.`attendance_legal_entities_holiday_amounts`.`year` = `ej2_showtime_p`.`attendance_holiday_rules`.`year`)))) group by `ej2_showtime_p`.`attendance_holiday_rules_legal_entities_rel`.`core_legal_entities_id`,`ej2_showtime_p`.`attendance_legal_entities_holiday_amounts`.`year`,`ej2_showtime_p`.`attendance_holiday_rules`.`id`,`ej2_showtime_p`.`attendance_holiday_rule_schedules`.`id`) `total` on(((`total`.`legal_entity` = `legal_entities_rel`.`core_legal_entities_id`) and (`total`.`total_year` = `rules`.`year`)))) left join (select `ej2_showtime_p`.`attendance_holiday_rule_schedules_permission_groups_rel`.`attendance_holiday_rule_schedule_id` AS `attendance_holiday_rule_schedule_id`,concat(group_concat(`ej2_showtime_p`.`attendance_holiday_rule_schedules_permission_groups_rel`.`core_permission_group_id` order by `ej2_showtime_p`.`attendance_holiday_rule_schedules_permission_groups_rel`.`core_permission_group_id` ASC separator ',')) AS `core_permission_group_id` from `ej2_showtime_p`.`attendance_holiday_rule_schedules_permission_groups_rel` group by `ej2_showtime_p`.`attendance_holiday_rule_schedules_permission_groups_rel`.`attendance_holiday_rule_schedule_id`) `permission_groups_rel` on((`permission_groups_rel`.`attendance_holiday_rule_schedule_id` = `rules_schedules`.`id`))) left join (select `ej2_showtime_p`.`attendance_legal_entities_holiday_amounts`.`core_legal_entities_id` AS `core_legal_entities_id`,`ej2_showtime_p`.`attendance_legal_entities_holiday_amounts`.`year` AS `year`,sum(`ej2_showtime_p`.`attendance_legal_entities_holiday_amounts`.`value`) AS `value`,sum(`ej2_showtime_p`.`attendance_legal_entities_holiday_amounts`.`used_value`) AS `used_value` from `ej2_showtime_p`.`attendance_legal_entities_holiday_amounts` where (0 <> find_in_set(`ej2_showtime_p`.`attendance_legal_entities_holiday_amounts`.`attendance_offday_types_id`,'1,2,3,4,5,6,7,99')) group by `ej2_showtime_p`.`attendance_legal_entities_holiday_amounts`.`core_legal_entities_id`,`ej2_showtime_p`.`attendance_legal_entities_holiday_amounts`.`year`) `holiday_amounts` on(((`holiday_amounts`.`core_legal_entities_id` = `legal_entities_rel`.`core_legal_entities_id`) and (`holiday_amounts`.`year` = `rules`.`year`)))) left join (select `dates`.`core_legal_entities_id` AS `core_legal_entities_id`,`dates`.`id` AS `id`,sum(`dates`.`used`) AS `used`,group_concat(`dates`.`used_dates` separator ',') AS `used_dates`,group_concat(`dates`.`used_created_ats` separator ',') AS `used_created_ats`,group_concat(`dates`.`used_abscences_ids` separator ',') AS `used_abscences_ids`,sum(`dates`.`planned`) AS `planned`,group_concat(`dates`.`planned_dates` separator ',') AS `planned_dates`,group_concat(`dates`.`planned_created_ats` separator ',') AS `planned_created_ats`,group_concat(`dates`.`planned_abscences_ids` separator ',') AS `planned_abscences_ids` from (select `calendar`.`core_legal_entities_id` AS `core_legal_entities_id`,`rules_schedules`.`id` AS `id`,sum((case when `calendar`.`_date` then 1 else 0 end)) AS `used`,group_concat(`calendar`.`_date` order by `calendar`.`_date` ASC separator ',') AS `used_dates`,group_concat(cast(`abscences`.`created_at` as date) order by `calendar`.`_date` ASC separator ',') AS `used_created_ats`,group_concat(`abscences`.`id` order by `calendar`.`_date` ASC separator ',') AS `used_abscences_ids`,NULL AS `planned`,NULL AS `planned_dates`,NULL AS `planned_created_ats`,NULL AS `planned_abscences_ids` from ((((`ej2_showtime_p`.`attendance_legal_entities_abscences` `abscences` join `ej2_showtime_p`.`attendance_legal_entities_calendar` `calendar` on((`calendar`.`id` = `abscences`.`registered_calendar_id`))) join `ej2_showtime_p`.`attendance_holiday_rules_legal_entities_rel` `legal_entities_rel` on((`legal_entities_rel`.`core_legal_entities_id` = `calendar`.`core_legal_entities_id`))) join `ej2_showtime_p`.`attendance_holiday_rules` `rules` on((`rules`.`id` = `legal_entities_rel`.`attendance_holiday_rule_id`))) join `ej2_showtime_p`.`attendance_holiday_rule_schedules` `rules_schedules` on((`rules_schedules`.`attendance_holiday_rule_id` = `rules`.`id`))) where ((`calendar`.`_date` between `rules_schedules`.`planning_from_date` and `rules_schedules`.`planning_to_date`) and (`calendar`.`legal_entity_confirmed` = 1) and (`calendar`.`boss_confirmed` = 1) and (`abscences`.`attendance_abscence_types_id` is null) and (`abscences`.`attendance_offday_types_id` is not null) and (0 <> find_in_set(`abscences`.`attendance_offday_types_id`,'1,2,3,4,5,6,7,99'))) group by `calendar`.`core_legal_entities_id`,`rules_schedules`.`id` union select `calendar`.`core_legal_entities_id` AS `core_legal_entities_id`,`rules_schedules`.`id` AS `id`,NULL AS `used`,NULL AS `used_dates`,NULL AS `used_created_ats`,NULL AS `used_abscences_ids`,sum((case when `calendar`.`_date` then 1 else 0 end)) AS `planned`,group_concat(`calendar`.`_date` order by `calendar`.`_date` ASC separator ',') AS `planned_dates`,group_concat(cast(`abscences`.`created_at` as date) order by `calendar`.`_date` ASC separator ',') AS `planned_created_ats`,group_concat(`abscences`.`id` order by `calendar`.`_date` ASC separator ',') AS `planned_abscences_ids` from ((((`ej2_showtime_p`.`attendance_legal_entities_abscences` `abscences` join `ej2_showtime_p`.`attendance_legal_entities_calendar` `calendar` on((`calendar`.`id` = `abscences`.`registered_calendar_id`))) join `ej2_showtime_p`.`attendance_holiday_rules_legal_entities_rel` `legal_entities_rel` on((`legal_entities_rel`.`core_legal_entities_id` = `calendar`.`core_legal_entities_id`))) join `ej2_showtime_p`.`attendance_holiday_rules` `rules` on((`rules`.`id` = `legal_entities_rel`.`attendance_holiday_rule_id`))) join `ej2_showtime_p`.`attendance_holiday_rule_schedules` `rules_schedules` on((`rules_schedules`.`attendance_holiday_rule_id` = `rules`.`id`))) where ((`calendar`.`_date` between `rules_schedules`.`planning_from_date` and `rules_schedules`.`planning_to_date`) and ((`calendar`.`legal_entity_confirmed` = 0) or (`calendar`.`boss_confirmed` = 0)) and (`abscences`.`attendance_abscence_types_id` is null) and (`abscences`.`attendance_offday_types_id` is not null) and (0 <> find_in_set(`abscences`.`attendance_offday_types_id`,'1,2,3,4,5,6,7,99'))) group by `calendar`.`core_legal_entities_id`,`rules_schedules`.`id`) `dates` group by `dates`.`core_legal_entities_id`,`dates`.`id`) `offdays` on(((`offdays`.`core_legal_entities_id` = `legal_entities_rel`.`core_legal_entities_id`) and (`offdays`.`id` = `rules_schedules`.`id`)))) group by `legal_entities_rel`.`core_legal_entities_id`,`rules`.`id`,`rules_schedules`.`id`,`holiday_amounts`.`value`,`offdays`.`used`,`offdays`.`used_dates`,`offdays`.`planned`,`offdays`.`planned_dates` order by `legal_entities_rel`.`core_legal_entities_id`,`rules`.`id`,`rules_schedules`.`id`");
    }

    /**
     * Reverse the migrations.
     *
     * @return void
     */
    public function down()
    {
        DB::statement("DROP VIEW IF EXISTS `view_holiday_schedule_query`");
    }
};
